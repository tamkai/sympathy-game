<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Party Box - Play</title>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&family=Outfit:wght@400;700&display=swap"
        rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="/static/css/style.css" rel="stylesheet">
    <script src="/static/js/player.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>

<body x-data="playerApp()" x-init="init()" class="min-h-[100dvh] flex flex-col">

    <!-- Header -->
    <div class="glass p-3 text-center text-sm font-bold z-50 text-violet">
        Party Box <span x-show="hasJoined" x-text="'@ ' + playerName" class="text-pink ml-2"></span>
    </div>

    <!-- Main Container -->
    <div class="flex-1 flex flex-col justify-center items-center p-4 w-full max-w-md mx-auto relative overflow-hidden">

        <!-- Phase: LOGIN (Before Joining) -->
        <template x-if="!hasJoined">
            <div class="glass p-8 rounded-2xl w-full flex flex-col gap-6 animate-fade-in">
                <h1 class="text-2xl font-bold text-center text-violet">ゲームに参加</h1>
                <input type="text" x-model="nameInput" placeholder="ニックネーム"
                    class="w-full bg-white/50 border border-white rounded-lg p-4 text-violet placeholder-violet/50 focus:outline-none focus:ring-2 focus:ring-pink-300 text-lg shadow-inner">
                <button @click="joinGame" :disabled="!nameInput"
                    class="btn-primary py-4 font-bold disabled:opacity-50 disabled:cursor-not-allowed">
                    参加する
                </button>
            </div>
        </template>

        <!-- Phase: DESCRIPTION / INSTRUCTION (Role & Topic) -->
        <template x-if="hasJoined && (phase === 'DESCRIPTION' || phase === 'INSTRUCTION') && mode === 'WORD_WOLF'">
            <div class="glass p-6 rounded-2xl w-full text-center animate-fade-in flex flex-col gap-6">
                <div class="flex flex-col items-center">
                    <span class="text-xs font-bold text-violet bg-white/50 px-3 py-1 rounded-full mb-2">YOUR ROLE</span>
                    <template x-if="myRole === 'WOLF'">
                        <div class="text-6xl animate-bounce">🐺</div>
                    </template>
                    <template x-if="myRole === 'VILLAGER'">
                        <div class="text-6xl animate-bounce">🧑‍🌾</div>
                    </template>
                    <h2 class="text-2xl font-bold mt-2 text-violet" x-text="myRole === 'WOLF' ? 'ウルフ' : '市民'"></h2>
                </div>

                <div class="bg-white/40 p-4 rounded-xl border border-white/50" @click="topicRevealed = !topicRevealed">
                    <div class="text-sm opacity-70 mb-1 text-violet font-bold">今回のお題</div>
                    <div class="text-3xl font-bold text-pink-600 drop-shadow-sm transition-all duration-300 cursor-pointer select-none"
                        :class="topicRevealed ? '' : 'blur-sm'"
                        x-text="myTopic"></div>
                    <p class="text-xs mt-2 opacity-50 text-violet" x-text="topicRevealed ? 'タップして隠す' : 'タップしてこっそり確認してね'"></p>
                </div>

                <div class="bg-violet-800 p-4 rounded-xl text-white text-sm leading-relaxed shadow-lg">
                    <p x-show="myRole === 'VILLAGER'">
                        周りの人と会話して、<br>
                        <span class="font-bold text-yellow-300">一人だけ違うお題</span>について<br>
                        話している人（ウルフ）を探し出そう！
                    </p>
                    <p x-show="myRole === 'WOLF'">
                        周りの会話に合わせて<br>
                        <span class="font-bold text-yellow-300">話を合わせよう！</span><br>
                        ウルフだとバレないように注意して！
                    </p>
                </div>
            </div>
        </template>

        <!-- Phase: JUDGING (Voting for Word Wolf) -->
        <template x-if="hasJoined && phase === 'JUDGING' && mode === 'WORD_WOLF'">
            <div class="w-full flex flex-col gap-4 animate-fade-in">
                <div class="text-center mb-4">
                    <h2 class="text-2xl font-bold text-violet">投票タイム！</h2>
                    <p class="text-sm text-violet opacity-80">ウルフだと思う人を選んで投票してね</p>
                </div>

                <div x-show="!hasAnswered"
                    class="grid grid-cols-2 gap-3 max-h-[400px] overflow-y-auto w-full px-1 py-2">
                    <template x-for="player in Object.values(players)" :key="player.player_id">
                        <button @click="voteTarget = player.player_id" x-show="player.player_id !== myPlayerId"
                            :class="voteTarget === player.player_id ? 'bg-pink-500 text-white transform scale-105 shadow-lg border-2 border-white' : 'glass hover:bg-white/40 text-violet'"
                            class="p-4 rounded-xl font-bold transition-all duration-200 flex flex-col items-center gap-2">
                            <span class="text-xl" x-text="player.name[0]"></span>
                            <span class="text-sm truncate w-full" x-text="player.name"></span>
                        </button>
                    </template>
                </div>

                <div x-show="!hasAnswered"
                    class="sticky bottom-0 pb-4 pt-2 bg-gradient-to-t from-pink-100/50 to-transparent">
                    <button @click="submitVote" :disabled="!voteTarget"
                        class="w-full btn-primary py-4 text-xl font-bold active:scale-95 disabled:opacity-50 disabled:scale-100 disabled:cursor-not-allowed shadow-xl">
                        投票する
                    </button>
                </div>

                <div x-show="hasAnswered" class="text-center animate-pulse text-violet glass p-8 rounded-2xl">
                    <div class="text-6xl mb-4">🗳️</div>
                    <h3 class="text-xl font-bold">投票完了！</h3>
                    <p class="text-sm opacity-80 mt-2">結果発表を待ってね...</p>
                </div>
            </div>
        </template>

        <!-- Phase: WORD_WOLF_RESULT needs to be handled? reusing RESULT Phase for now -->

        <!-- Sympathy LOBBY / Waiting -->
        <template
            x-if="hasJoined && mode === 'SYMPATHY' && (phase === 'LOBBY' || (phase === 'ANSWERING' && hasAnswered) || phase === 'JUDGING' || phase === 'INSTRUCTION')">
            <div class="text-center animate-pulse text-violet">
                <div class="text-6xl mb-4">💣</div>
                <h2 class="text-xl font-bold mb-2">Wait a moment!</h2>
                <div x-show="phase === 'LOBBY'">
                    <p class="text-sm opacity-80">ホストが開始するのを待ってね</p>
                </div>
                <div x-show="phase === 'JUDGING'">
                    <p class="text-sm opacity-80">集計中... ドキドキ...</p>
                </div>
            </div>
        </template>

        <!-- Generic LOBBY for ITO and SEKAI_NO_MIKATA -->
        <template x-if="hasJoined && phase === 'LOBBY' && (mode === 'ITO' || mode === 'SEKAI_NO_MIKATA')">
            <div class="text-center animate-pulse text-violet">
                <div class="text-6xl mb-4">🎮</div>
                <h2 class="text-xl font-bold mb-2">準備完了！</h2>
                <p class="text-sm opacity-80">ホストがゲームを開始するのを待ってね</p>
            </div>
        </template>

        <!-- Word Wolf LOBBY -->
        <template x-if="hasJoined && phase === 'LOBBY' && mode === 'WORD_WOLF'">
            <div class="text-center animate-pulse text-violet">
                <div class="text-6xl mb-4">🐺</div>
                <h2 class="text-xl font-bold mb-2">ワードウルフ</h2>
                <p class="text-sm opacity-80">ホストがゲームを開始するのを待ってね</p>
            </div>
        </template>

        <!-- Word Wolf Waiting (During Discussion) -->
        <template x-if="hasJoined && (phase === 'ANSWERING' && mode === 'WORD_WOLF')">
            <div class="glass p-8 rounded-2xl w-full text-center flex flex-col gap-6 animate-pulse-slow">
                <h2 class="text-2xl font-bold text-violet">議論中...</h2>
                <div class="text-6xl">🗣️</div>
                <div class="bg-white/40 p-4 rounded-xl" @click="topicRevealed = !topicRevealed">
                    <div class="text-xs opacity-70 mb-1 text-violet font-bold">あなたのお題</div>
                    <div class="text-2xl font-bold text-pink-600 cursor-pointer transition-all"
                        :class="topicRevealed ? '' : 'blur-sm'"
                        x-text="myTopic"></div>
                    <p class="text-xs mt-1 opacity-50 text-violet" x-text="topicRevealed ? 'タップして隠す' : 'タップで確認'"></p>
                </div>
                <p class="text-sm opacity-80 text-violet">みんなと話し合ってウルフを見つけよう（または騙そう）！</p>
            </div>
        </template>

        <!-- Phase: ANSWERING (Sympathy Input) -->
        <template x-if="hasJoined && phase === 'ANSWERING' && !hasAnswered && mode === 'SYMPATHY'">
            <div class="w-full flex flex-col gap-6 animate-fade-in">
                <div class="glass p-6 rounded-2xl">
                    <div class="text-xs opacity-70 mb-1 text-violet">Questions</div>
                    <h2 class="text-xl font-bold leading-relaxed text-violet" x-text="currentQuestion"></h2>
                </div>

                <div class="glass p-4 rounded-2xl">
                    <textarea x-model="answerInput" rows="3" placeholder="回答を入力..."
                        class="w-full bg-transparent border-none text-violet placeholder-violet/40 text-xl focus:ring-0 resize-none font-bold"></textarea>
                </div>

                <!-- Shuffle Power-up -->
                <div x-show="config.shuffle && shuffleRemaining > 0" class="flex justify-end px-2">
                    <label class="flex items-center gap-2 cursor-pointer text-violet font-bold">
                        <input type="checkbox" x-model="useShuffle" class="w-5 h-5 accent-pink-500 rounded">
                        <span>⚡ アンサーシャッフル (残り1回)</span>
                    </label>
                </div>

                <button @click="submitAnswer" :disabled="!answerInput"
                    class="btn-primary py-4 text-xl font-bold active:scale-95">
                    送信！
                </button>
            </div>
        </template>

        <!-- Phase: RESULT -->
        <template x-if="hasJoined && phase === 'RESULT' && mode === 'SYMPATHY'">
            <div class="glass p-8 rounded-2xl w-full text-center animate-fade-in">
                <h2 class="text-3xl font-bold mb-6 text-pink">RESULT</h2>

                <div class="mb-8 text-violet">
                    <div class="text-sm opacity-80 mb-2">あなたの順位</div>
                    <div class="text-5xl font-mono font-bold" x-text="myRank + '位'"></div>
                    <div class="text-xl mt-2" x-text="myScore + ' pts'"></div>
                </div>

                <!-- Bomb Alert -->
                <template x-if="myPlayerId === bombOwnerId">
                    <div class="bg-red-100/90 p-4 rounded-xl mb-4 animate-bounce border-2 border-red-500">
                        <div class="text-5xl mb-2">💣</div>
                        <div class="font-bold text-red-600 text-lg">DANGER!</div>
                        <div class="text-sm text-red-800">あなたが「爆弾」を持っています...<br>勝利できません！</div>
                    </div>
                </template>

                <p class="text-sm opacity-70 text-violet">Please wait for next round...</p>
            </div>
        </template>

        <!-- ======================= -->
        <!-- SEKAI NO MIKATA PHASES -->
        <!-- ======================= -->

        <!-- Phase: ANSWERING (Sekai - 親の場合：待機) -->
        <template x-if="hasJoined && phase === 'ANSWERING' && mode === 'SEKAI_NO_MIKATA' && isReader">
            <div class="glass p-6 rounded-2xl w-full text-center flex flex-col gap-4 animate-fade-in">
                <div class="bg-amber-500 text-white px-4 py-2 rounded-full font-bold inline-block mx-auto">
                    あなたは親です
                </div>
                <div class="text-4xl">👑</div>
                <div class="bg-white/40 p-4 rounded-xl">
                    <div class="text-sm text-violet/70 mb-1">今回のお題</div>
                    <div class="text-xl font-bold text-violet" x-text="sekaiState?.current_question || ''"></div>
                </div>
                <p class="text-sm text-violet opacity-80">
                    みんなの回答を待っています...<br>
                    回答が揃ったらお気に入りを選んでね！
                </p>
                <div class="text-6xl animate-pulse">⏳</div>
            </div>
        </template>

        <!-- Phase: ANSWERING (Sekai - 子の場合：回答入力) -->
        <template x-if="hasJoined && phase === 'ANSWERING' && mode === 'SEKAI_NO_MIKATA' && !isReader && !hasAnswered">
            <div class="w-full flex flex-col gap-4 animate-fade-in">
                <div class="glass p-4 rounded-xl text-center">
                    <div class="text-xs text-violet/70 mb-1">親: <span x-text="sekaiReaderName"></span></div>
                    <div class="text-lg font-bold text-violet" x-text="sekaiState?.current_question || ''"></div>
                </div>

                <div class="glass p-4 rounded-xl">
                    <div class="text-sm font-bold text-violet mb-3">単語を選んでね！</div>
                    <div class="grid grid-cols-2 gap-2">
                        <template x-for="word in myWordChoices" :key="word">
                            <button @click="selectWord(word)"
                                :class="selectedWord === word ? 'bg-amber-500 text-white ring-2 ring-amber-300' : 'bg-white/80 text-violet hover:bg-amber-100'"
                                class="p-3 rounded-xl font-bold text-sm transition-all">
                                <span x-text="word"></span>
                            </button>
                        </template>
                    </div>
                </div>

                <div class="glass p-4 rounded-xl">
                    <div class="text-sm font-bold text-violet mb-2">または自由入力</div>
                    <input type="text" x-model="customAnswer" @input="selectedWord = ''"
                        placeholder="オリジナルの回答を入力..."
                        class="w-full p-3 rounded-xl border-2 border-violet/20 focus:border-amber-400 focus:outline-none text-violet font-bold">
                </div>

                <button @click="submitSekaiAnswer" :disabled="!selectedWord && !customAnswer"
                    class="w-full py-4 text-xl font-bold bg-amber-500 text-white rounded-xl shadow-lg disabled:opacity-50 disabled:cursor-not-allowed hover:bg-amber-600 transition">
                    回答を送信！
                </button>
            </div>
        </template>

        <!-- Phase: ANSWERING (Sekai - 回答済み) -->
        <template x-if="hasJoined && phase === 'ANSWERING' && mode === 'SEKAI_NO_MIKATA' && !isReader && hasAnswered">
            <div class="glass p-8 rounded-2xl w-full text-center flex flex-col gap-4 animate-fade-in">
                <div class="text-4xl">✅</div>
                <h2 class="text-xl font-bold text-violet">回答送信済み！</h2>
                <p class="text-sm text-violet opacity-80">他のプレイヤーを待っています...</p>
            </div>
        </template>

        <!-- Phase: JUDGING (Sekai - 親が選んでいる間) -->
        <template x-if="hasJoined && phase === 'JUDGING' && mode === 'SEKAI_NO_MIKATA'">
            <div class="glass p-8 rounded-2xl w-full text-center flex flex-col gap-4 animate-fade-in">
                <div class="text-4xl animate-bounce">🤔</div>
                <h2 class="text-xl font-bold text-violet">
                    <span x-text="sekaiReaderName"></span>が選んでいます...
                </h2>
                <p class="text-sm text-violet opacity-80">親がお気に入りの回答を選んでいます</p>
            </div>
        </template>

        <!-- Phase: RESULT (Sekai) -->
        <template x-if="hasJoined && phase === 'RESULT' && mode === 'SEKAI_NO_MIKATA'">
            <div class="glass p-6 rounded-2xl w-full text-center flex flex-col gap-4 animate-fade-in">
                <h2 class="text-xl font-bold text-violet">結果発表！</h2>

                <div class="bg-white/40 p-4 rounded-xl">
                    <div class="text-2xl font-bold text-violet" x-text="myScore + ' pt'"></div>
                    <div class="text-sm text-violet/70">あなたのスコア</div>
                </div>

                <div class="text-sm text-violet">
                    順位: <span class="font-bold text-lg" x-text="myRank"></span>位
                </div>

                <template x-if="winnerId === clientId">
                    <div class="bg-gradient-to-r from-yellow-300 to-amber-400 p-6 rounded-2xl text-center">
                        <div class="text-4xl mb-2">🎉🏆🎉</div>
                        <div class="text-2xl font-bold text-amber-800">優勝！</div>
                    </div>
                </template>

                <p class="text-sm text-violet opacity-70">ホストの画面を見てね！</p>
            </div>
        </template>

        <!-- ======================= -->
        <!-- ITO PHASES -->
        <!-- ======================= -->

        <!-- Phase: INSTRUCTION (Ito - ルール確認と自分の数字確認) -->
        <template x-if="hasJoined && phase === 'INSTRUCTION' && mode === 'ITO' && itoState">
            <div class="glass p-6 rounded-2xl w-full text-center flex flex-col gap-4 animate-fade-in">
                <!-- 協力モード: ステージ表示 -->
                <template x-if="itoState.is_coop_mode">
                    <div class="bg-emerald-500 text-white px-4 py-2 rounded-full font-bold inline-block mx-auto">
                        ito - Stage <span x-text="itoState.stage"></span>
                    </div>
                </template>
                <!-- 通常モード -->
                <template x-if="!itoState.is_coop_mode">
                    <div class="bg-blue-500 text-white px-4 py-2 rounded-full font-bold inline-block mx-auto">
                        ito
                    </div>
                </template>

                <!-- 自分の数字 -->
                <div class="bg-white/40 p-6 rounded-2xl" @click="numberRevealed = !numberRevealed">
                    <div class="text-sm text-violet/70 mb-2 font-bold">あなたの数字</div>
                    <div class="text-7xl font-bold transition-all duration-300 cursor-pointer select-none"
                         :class="numberRevealed ? 'text-emerald-600' : 'blur-lg text-gray-400'"
                         x-text="myNumber"></div>
                    <p class="text-xs mt-2 opacity-50 text-violet" x-text="numberRevealed ? 'タップして隠す' : 'タップして確認（他の人に見せないで！）'"></p>
                </div>

                <!-- お題 -->
                <div class="bg-emerald-100 p-4 rounded-xl border border-emerald-300">
                    <div class="text-sm text-emerald-700 mb-1">今回のお題</div>
                    <div class="text-xl font-bold text-emerald-800" x-text="itoState.current_topic"></div>
                </div>

                <p class="text-sm text-violet opacity-80">
                    この数字をお題に沿って<br>
                    <span class="font-bold text-emerald-600">言葉で表現</span>してね！
                </p>
            </div>
        </template>

        <!-- Phase: ANSWERING (Ito - カードを出すフェーズ) -->
        <template x-if="hasJoined && phase === 'ANSWERING' && mode === 'ITO' && itoState && !hasAnswered">
            <div class="glass p-6 rounded-2xl w-full flex flex-col gap-4 animate-fade-in">
                <!-- ステータス -->
                <div class="flex justify-between items-center">
                    <!-- 協力モード: ステージ表示 -->
                    <template x-if="itoState.is_coop_mode">
                        <div class="bg-emerald-500 text-white px-3 py-1 rounded-full font-bold text-sm">
                            Stage <span x-text="itoState.stage"></span>
                        </div>
                    </template>
                    <!-- 通常モード -->
                    <template x-if="!itoState.is_coop_mode">
                        <div class="bg-blue-500 text-white px-3 py-1 rounded-full font-bold text-sm">
                            ito
                        </div>
                    </template>
                    <!-- ライフは協力モードのみ -->
                    <template x-if="itoState.is_coop_mode">
                        <div class="flex gap-1">
                            <template x-for="i in 3" :key="i">
                                <span class="text-lg" x-text="i <= itoState.life ? '❤️' : '🖤'"></span>
                            </template>
                        </div>
                    </template>
                </div>

                <!-- お題 -->
                <div class="bg-white/40 p-3 rounded-xl text-center">
                    <div class="text-xs text-violet/70">お題</div>
                    <div class="text-lg font-bold text-violet" x-text="itoState.current_topic"></div>
                </div>

                <!-- 自分の数字 -->
                <div class="bg-emerald-50 p-6 rounded-2xl text-center border-2 border-emerald-300" @click="numberRevealed = !numberRevealed">
                    <div class="text-sm text-emerald-700 mb-1">あなたの数字</div>
                    <div class="text-6xl font-bold transition-all duration-300 cursor-pointer select-none"
                         :class="numberRevealed ? 'text-emerald-600' : 'blur-lg text-gray-400'"
                         x-text="myNumber"></div>
                    <p class="text-xs mt-1 opacity-50 text-emerald-700" x-text="numberRevealed ? 'タップして隠す' : 'タップで確認'"></p>
                </div>

                <!-- カードを出すボタン -->
                <button @click="showPlayCardConfirm = true"
                    class="w-full py-4 text-xl font-bold bg-gradient-to-r from-emerald-500 to-teal-600 text-white rounded-xl shadow-lg hover:shadow-xl transition-all active:scale-95">
                    カードを出す
                </button>

                <p class="text-xs text-center text-violet opacity-70">
                    みんなで相談して、小さい順にカードを出そう！
                </p>
            </div>
        </template>

        <!-- Phase: ANSWERING (Ito - カード出し済み) -->
        <template x-if="hasJoined && phase === 'ANSWERING' && mode === 'ITO' && itoState && hasAnswered">
            <div class="glass p-8 rounded-2xl w-full text-center flex flex-col gap-4 animate-fade-in">
                <div class="text-4xl">✅</div>
                <h2 class="text-xl font-bold text-violet">カードを出しました！</h2>
                <div class="bg-emerald-100 p-4 rounded-xl">
                    <div class="text-sm text-emerald-700">あなたの数字</div>
                    <div class="text-4xl font-bold text-emerald-600" x-text="myNumber"></div>
                </div>
                <p class="text-sm text-violet opacity-80">他のプレイヤーを待っています...</p>
            </div>
        </template>

        <!-- Phase: RESULT (Ito) -->
        <template x-if="hasJoined && phase === 'RESULT' && mode === 'ITO' && itoState">
            <div class="glass p-6 rounded-2xl w-full text-center flex flex-col gap-4 animate-fade-in">
                <!-- 協力モードの結果 -->
                <template x-if="itoState.is_coop_mode">
                    <template x-if="itoState.game_cleared">
                        <div class="bg-gradient-to-r from-yellow-300 to-amber-400 p-6 rounded-2xl">
                            <div class="text-4xl mb-2">🎉🏆🎉</div>
                            <h2 class="text-2xl font-bold text-amber-800">GAME CLEAR!</h2>
                            <p class="text-amber-700">全ステージクリア！</p>
                        </div>
                    </template>

                    <template x-if="itoState.game_over">
                        <div class="bg-gradient-to-r from-gray-300 to-gray-400 p-6 rounded-2xl">
                            <div class="text-4xl mb-2">💀</div>
                            <h2 class="text-2xl font-bold text-gray-700">GAME OVER</h2>
                            <p class="text-gray-600">ライフが0に...</p>
                        </div>
                    </template>

                    <template x-if="!itoState.game_cleared && !itoState.game_over">
                        <div class="bg-white/40 p-4 rounded-xl">
                            <div class="text-sm text-violet/70">ステージ結果</div>
                            <div class="text-xl font-bold" :class="itoState.is_failed ? 'text-red-600' : 'text-emerald-600'"
                                 x-text="itoState.is_failed ? 'FAILED...' : 'CLEAR!'"></div>
                        </div>
                    </template>

                    <!-- スタッツ（協力モード） -->
                    <div class="grid grid-cols-3 gap-2 text-sm">
                        <div class="bg-white/30 p-2 rounded-lg">
                            <div class="font-bold text-emerald-600" x-text="itoState.stage"></div>
                            <div class="text-violet/70 text-xs">ステージ</div>
                        </div>
                        <div class="bg-white/30 p-2 rounded-lg">
                            <div class="font-bold text-red-500" x-text="itoState.life"></div>
                            <div class="text-violet/70 text-xs">ライフ</div>
                        </div>
                        <div class="bg-white/30 p-2 rounded-lg">
                            <div class="font-bold text-violet" x-text="myNumber"></div>
                            <div class="text-violet/70 text-xs">あなたの数字</div>
                        </div>
                    </div>
                </template>

                <!-- 通常モードの結果 -->
                <template x-if="!itoState.is_coop_mode">
                    <template x-if="itoState.stage_cleared">
                        <div class="bg-gradient-to-r from-emerald-300 to-teal-400 p-6 rounded-2xl">
                            <div class="text-4xl mb-2">🎉✨🎉</div>
                            <h2 class="text-2xl font-bold text-emerald-800">SUCCESS!</h2>
                            <p class="text-emerald-700">正しい順番でした！</p>
                        </div>
                    </template>

                    <template x-if="!itoState.stage_cleared">
                        <div class="bg-gradient-to-r from-red-300 to-orange-400 p-6 rounded-2xl">
                            <div class="text-4xl mb-2">😢</div>
                            <h2 class="text-2xl font-bold text-red-800">FAILED...</h2>
                            <p class="text-red-700">順番が違っていました</p>
                        </div>
                    </template>

                    <!-- スタッツ（通常モード） -->
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <div class="bg-white/30 p-2 rounded-lg">
                            <div class="font-bold text-violet" x-text="myNumber"></div>
                            <div class="text-violet/70 text-xs">あなたの数字</div>
                        </div>
                        <div class="bg-white/30 p-2 rounded-lg">
                            <div class="font-bold" :class="itoState.stage_cleared ? 'text-emerald-600' : 'text-red-600'"
                                 x-text="itoState.stage_cleared ? 'OK' : 'NG'"></div>
                            <div class="text-violet/70 text-xs">結果</div>
                        </div>
                    </div>
                </template>

                <p class="text-sm text-violet opacity-70">ホストの画面を見てね！</p>
            </div>
        </template>

        <!-- ======================= -->
        <!-- ONE NIGHT WEREWOLF PHASES -->
        <!-- ======================= -->

        <!-- Phase: LOBBY (Werewolf - 待機中) -->
        <template x-if="hasJoined && phase === 'LOBBY' && mode === 'ONE_NIGHT_WEREWOLF'">
            <div class="text-center animate-pulse text-violet">
                <div class="text-6xl mb-4">🌙</div>
                <h2 class="text-xl font-bold mb-2">ワンナイト人狼</h2>
                <p class="text-sm opacity-80">ホストがゲームを開始するのを待ってね</p>
            </div>
        </template>

        <!-- Phase: INSTRUCTION (Werewolf - 役職確認) -->
        <template x-if="hasJoined && phase === 'INSTRUCTION' && mode === 'ONE_NIGHT_WEREWOLF' && werewolfState">
            <div class="glass p-6 rounded-2xl w-full text-center flex flex-col gap-4 animate-fade-in bg-gradient-to-b from-slate-800/80 to-slate-900/80">
                <div class="text-5xl">🌙</div>
                <h2 class="text-2xl font-bold text-white">ワンナイト人狼</h2>

                <!-- 役職カード -->
                <div class="bg-white/10 p-6 rounded-2xl" @click="roleRevealed = !roleRevealed">
                    <div class="text-sm text-white/70 mb-2 font-bold">あなたの役職</div>
                    <div class="transition-all duration-300"
                         :class="roleRevealed ? '' : 'blur-lg'">
                        <div class="text-6xl mb-2"
                             x-text="myWerewolfRole === 'werewolf' ? '🐺' : (myWerewolfRole === 'seer' ? '🔮' : (myWerewolfRole === 'thief' ? '🦹' : (myWerewolfRole === 'madman' ? '🃏' : '🧑‍🌾')))"></div>
                        <div class="text-3xl font-bold text-white"
                             x-text="myWerewolfRole === 'werewolf' ? '人狼' : (myWerewolfRole === 'seer' ? '占い師' : (myWerewolfRole === 'thief' ? '怪盗' : (myWerewolfRole === 'madman' ? '狂人' : '村人')))"></div>
                    </div>
                    <p class="text-xs mt-2 opacity-50 text-white" x-text="roleRevealed ? 'タップして隠す' : 'タップして確認（他の人に見せないで！）'"></p>
                </div>

                <!-- 役職説明 -->
                <div class="bg-white/10 p-4 rounded-xl text-left text-white/80 text-sm">
                    <template x-if="myWerewolfRole === 'villager'">
                        <p><span class="font-bold text-white">村人:</span> 能力はありません。議論で人狼を見つけ出しましょう！</p>
                    </template>
                    <template x-if="myWerewolfRole === 'werewolf'">
                        <p><span class="font-bold text-white">人狼:</span> 夜に仲間の人狼を確認できます。バレないように議論を乗り切りましょう！</p>
                    </template>
                    <template x-if="myWerewolfRole === 'seer'">
                        <p><span class="font-bold text-white">占い師:</span> 夜に他のプレイヤー1人か、墓地のカード1枚を見れます。</p>
                    </template>
                    <template x-if="myWerewolfRole === 'thief'">
                        <p><span class="font-bold text-white">怪盗:</span> 夜に他のプレイヤーと役職を交換できます（しなくてもOK）。</p>
                    </template>
                    <template x-if="myWerewolfRole === 'madman'">
                        <p><span class="font-bold text-white">狂人:</span> 人狼陣営ですが、人狼が誰かはわかりません。占われても「人間」と出ます。人狼を勝たせましょう！</p>
                    </template>
                </div>

                <p class="text-sm text-white/60">夜フェーズが始まるまでお待ちください</p>
            </div>
        </template>

        <!-- Phase: ANSWERING (Werewolf - 夜フェーズ) -->
        <template x-if="hasJoined && phase === 'ANSWERING' && mode === 'ONE_NIGHT_WEREWOLF' && werewolfState">
            <div class="glass p-6 rounded-2xl w-full flex flex-col gap-4 animate-fade-in bg-gradient-to-b from-slate-900/95 to-black/95">
                <div class="text-center">
                    <div class="text-4xl">🌙</div>
                    <h2 class="text-xl font-bold text-white">夜のフェーズ</h2>
                </div>

                <!-- 目を閉じるフェーズ -->
                <template x-if="werewolfState.night_phase === 'closing_eyes'">
                    <div class="bg-white/10 p-8 rounded-2xl text-center">
                        <div class="text-8xl mb-4 animate-pulse">😴</div>
                        <div class="text-2xl text-white font-bold">目を閉じてください</div>
                        <div class="text-white/60 mt-4">夜の行動が始まります...</div>
                    </div>
                </template>

                <!-- 自分の番でない場合（closing_eyes以外） -->
                <template x-if="werewolfState.night_phase !== 'closing_eyes' && !isMyNightTurn">
                    <div class="bg-white/10 p-8 rounded-2xl text-center">
                        <div class="text-6xl mb-4">😴</div>
                        <div class="text-xl text-white font-bold">目を閉じていてください</div>
                        <div class="text-white/60 mt-2">あなたの番になったら端末が震えます</div>
                    </div>
                </template>

                <!-- 人狼の番 -->
                <template x-if="isMyNightTurn && werewolfState.night_phase === 'werewolf' && myWerewolfRole === 'werewolf'">
                    <div class="bg-red-900/50 p-6 rounded-2xl text-center">
                        <div class="text-5xl mb-2">🐺</div>
                        <div class="text-xl text-white font-bold mb-4">あなたは人狼です</div>

                        <!-- 夜の行動済みかどうか -->
                        <template x-if="!werewolfState.night_actions_done[clientId]">
                            <div class="flex flex-col gap-4">
                                <p class="text-white/80" x-text="werewolfPartnerInfo || '仲間を確認してください'"></p>
                                <div class="bg-amber-500/30 p-3 rounded-xl text-amber-200 text-sm">
                                    確認したら目を閉じて「行動終了」をタップ
                                </div>
                                <button @click="werewolfConfirm"
                                    class="w-full py-4 bg-red-600 hover:bg-red-700 text-white rounded-xl font-bold transition text-lg">
                                    👁️ 行動終了（目を閉じた）
                                </button>
                            </div>
                        </template>
                        <template x-if="werewolfState.night_actions_done[clientId]">
                            <div class="text-emerald-400 font-bold">
                                ✓ 行動終了<br>
                                <span class="text-white/60 text-sm">目を閉じたまま待機してください</span>
                            </div>
                        </template>
                    </div>
                </template>

                <!-- 占い師の番 -->
                <template x-if="isMyNightTurn && werewolfState.night_phase === 'seer' && myWerewolfRole === 'seer'">
                    <div class="bg-blue-900/50 p-6 rounded-2xl">
                        <div class="text-center mb-4">
                            <div class="text-5xl mb-2">🔮</div>
                            <div class="text-xl text-white font-bold">占い師の時間</div>
                        </div>

                        <template x-if="!werewolfState.night_actions_done[clientId]">
                            <div class="flex flex-col gap-3">
                                <p class="text-white/80 text-center text-sm">タップで占う（墓地も可）</p>

                                <!-- プレイヤー選択（タップで即結果表示） -->
                                <div class="grid grid-cols-2 gap-2">
                                    <template x-for="player in Object.values(players)" :key="player.player_id">
                                        <button x-show="player.player_id !== clientId"
                                            @click="seerPeek(player.player_id)"
                                            :disabled="seerLocalResult && seerTarget !== player.player_id"
                                            :class="seerTarget === player.player_id ? 'bg-blue-500 text-white ring-2 ring-blue-300' : (seerLocalResult ? 'bg-white/10 text-white/40 cursor-not-allowed' : 'bg-white/20 text-white')"
                                            class="p-3 rounded-xl font-bold text-sm transition-all truncate">
                                            <span x-text="player.name"></span>
                                        </button>
                                    </template>
                                </div>

                                <!-- 墓地選択 -->
                                <div class="flex gap-2">
                                    <button @click="seerPeek('graveyard_0')"
                                        :disabled="seerLocalResult && seerTarget !== 'graveyard_0'"
                                        :class="seerTarget === 'graveyard_0' ? 'bg-blue-500 text-white ring-2 ring-blue-300' : (seerLocalResult ? 'bg-white/10 text-white/40 cursor-not-allowed' : 'bg-white/20 text-white')"
                                        class="flex-1 p-3 rounded-xl font-bold text-sm transition-all">
                                        墓地 1枚目
                                    </button>
                                    <button @click="seerPeek('graveyard_1')"
                                        :disabled="seerLocalResult && seerTarget !== 'graveyard_1'"
                                        :class="seerTarget === 'graveyard_1' ? 'bg-blue-500 text-white ring-2 ring-blue-300' : (seerLocalResult ? 'bg-white/10 text-white/40 cursor-not-allowed' : 'bg-white/20 text-white')"
                                        class="flex-1 p-3 rounded-xl font-bold text-sm transition-all">
                                        墓地 2枚目
                                    </button>
                                </div>

                                <!-- 占い結果の即時表示 -->
                                <template x-if="seerLocalResult">
                                    <div class="bg-blue-600/50 p-4 rounded-xl text-center">
                                        <div class="text-white/70 text-xs mb-1">占い結果</div>
                                        <div class="text-white font-bold text-lg" x-text="seerLocalResult"></div>
                                    </div>
                                </template>

                                <div class="bg-amber-500/30 p-3 rounded-xl text-amber-200 text-sm text-center">
                                    確認したら「行動終了」を押して目を閉じてください
                                </div>

                                <button @click="seerConfirm"
                                    class="w-full py-4 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-bold transition text-lg">
                                    👁️ 行動終了
                                </button>
                            </div>
                        </template>
                        <template x-if="werewolfState.night_actions_done[clientId]">
                            <div class="text-center">
                                <div class="text-emerald-400 font-bold mb-2">✓ 行動終了</div>
                                <div class="bg-white/20 p-3 rounded-xl text-white" x-text="seerLocalResult || werewolfState.night_info[clientId] || ''"></div>
                                <div class="text-white/60 text-sm mt-2">目を閉じたまま待機してください</div>
                            </div>
                        </template>
                    </div>
                </template>

                <!-- 怪盗の番 -->
                <template x-if="isMyNightTurn && werewolfState.night_phase === 'thief' && myWerewolfRole === 'thief'">
                    <div class="bg-purple-900/50 p-6 rounded-2xl">
                        <div class="text-center mb-4">
                            <div class="text-5xl mb-2">🦹</div>
                            <div class="text-xl text-white font-bold">怪盗の時間</div>
                        </div>

                        <template x-if="!werewolfState.night_actions_done[clientId]">
                            <div class="flex flex-col gap-3">
                                <p class="text-white/80 text-center text-sm">誰かと役職を交換しますか？</p>

                                <!-- プレイヤー選択 -->
                                <div class="grid grid-cols-2 gap-2">
                                    <template x-for="player in Object.values(players)" :key="player.player_id">
                                        <button x-show="player.player_id !== clientId"
                                            @click="thiefTarget = player.player_id"
                                            :class="thiefTarget === player.player_id ? 'bg-purple-500 text-white ring-2 ring-purple-300' : 'bg-white/20 text-white'"
                                            class="p-3 rounded-xl font-bold text-sm transition-all truncate">
                                            <span x-text="player.name"></span>
                                        </button>
                                    </template>
                                </div>

                                <div class="bg-amber-500/30 p-3 rounded-xl text-amber-200 text-sm text-center">
                                    終わったら目を閉じて「行動終了」をタップ
                                </div>

                                <div class="flex gap-2">
                                    <button @click="thiefSwap('skip')"
                                        class="flex-1 py-4 bg-gray-600 hover:bg-gray-700 text-white rounded-xl font-bold transition text-lg">
                                        👁️ 交換せず終了
                                    </button>
                                    <button @click="thiefSwap(thiefTarget)" :disabled="!thiefTarget"
                                        class="flex-1 py-4 bg-purple-600 hover:bg-purple-700 disabled:opacity-50 text-white rounded-xl font-bold transition text-lg">
                                        👁️ 交換して終了
                                    </button>
                                </div>
                            </div>
                        </template>
                        <template x-if="werewolfState.night_actions_done[clientId]">
                            <div class="text-center">
                                <div class="text-emerald-400 font-bold mb-2">✓ 行動終了</div>
                                <div class="bg-white/20 p-3 rounded-xl text-white" x-text="werewolfState.night_info[clientId] || ''"></div>
                                <div class="text-white/60 text-sm mt-2">目を閉じたまま待機してください</div>
                            </div>
                        </template>
                    </div>
                </template>

                <!-- 夜の情報表示（自分が得た情報） -->
                <template x-if="werewolfState.night_info[clientId] && werewolfState.night_actions_done[clientId]">
                    <div class="bg-white/10 p-3 rounded-xl">
                        <div class="text-xs text-white/60">夜に得た情報</div>
                        <div class="text-white font-bold" x-text="werewolfState.night_info[clientId]"></div>
                    </div>
                </template>
            </div>
        </template>

        <!-- Phase: JUDGING (Werewolf - 議論・投票) -->
        <template x-if="hasJoined && phase === 'JUDGING' && mode === 'ONE_NIGHT_WEREWOLF' && werewolfState">
            <div class="w-full flex flex-col gap-4 animate-fade-in">
                <div class="text-center">
                    <div class="text-4xl">☀️</div>
                    <h2 class="text-xl font-bold text-violet">議論タイム</h2>
                    <p class="text-sm text-violet/70">人狼だと思う人に投票してください</p>
                </div>

                <!-- 夜に得た情報（自分だけ見える） -->
                <template x-if="werewolfState.night_info[clientId]">
                    <div class="glass p-3 rounded-xl" @click="nightInfoRevealed = !nightInfoRevealed">
                        <div class="text-xs text-violet/60">夜に得た情報（タップで表示切替）</div>
                        <div class="font-bold transition-all"
                             :class="nightInfoRevealed ? 'text-violet' : 'blur-sm text-gray-400'"
                             x-text="werewolfState.night_info[clientId]"></div>
                    </div>
                </template>

                <!-- 投票 -->
                <template x-if="!hasAnswered">
                    <div class="flex flex-col gap-3">
                        <div class="grid grid-cols-2 gap-3">
                            <template x-for="player in Object.values(players)" :key="player.player_id">
                                <button x-show="player.player_id !== clientId"
                                    @click="werewolfVoteTarget = player.player_id"
                                    :class="werewolfVoteTarget === player.player_id ? 'bg-red-500 text-white ring-2 ring-red-300 scale-105' : 'glass text-violet hover:bg-white/40'"
                                    class="p-4 rounded-xl font-bold transition-all flex flex-col items-center gap-1">
                                    <span class="text-2xl" x-text="player.name[0]"></span>
                                    <span class="text-sm truncate w-full text-center" x-text="player.name"></span>
                                </button>
                            </template>
                        </div>

                        <!-- 平和村を願う -->
                        <button @click="werewolfVoteTarget = 'PEACE_VILLAGE'"
                            :class="werewolfVoteTarget === 'PEACE_VILLAGE' ? 'bg-emerald-500 text-white ring-2 ring-emerald-300 scale-105' : 'glass text-violet hover:bg-white/40'"
                            class="w-full p-4 rounded-xl font-bold transition-all flex items-center justify-center gap-2">
                            <span class="text-2xl">🌈</span>
                            <span>平和村を願う</span>
                        </button>

                        <button @click="submitWerewolfVote" :disabled="!werewolfVoteTarget"
                            class="w-full py-4 text-xl font-bold bg-red-500 hover:bg-red-600 disabled:opacity-50 text-white rounded-xl shadow-lg transition">
                            投票する
                        </button>
                    </div>
                </template>

                <template x-if="hasAnswered">
                    <div class="glass p-8 rounded-2xl text-center">
                        <div class="text-6xl mb-4">🗳️</div>
                        <h3 class="text-xl font-bold text-violet">投票完了！</h3>
                        <p class="text-sm text-violet/70 mt-2">結果発表を待ってね...</p>
                    </div>
                </template>
            </div>
        </template>

        <!-- Phase: RESULT (Werewolf) -->
        <template x-if="hasJoined && phase === 'RESULT' && mode === 'ONE_NIGHT_WEREWOLF' && werewolfState">
            <div class="glass p-6 rounded-2xl w-full text-center flex flex-col gap-4 animate-fade-in">
                <!-- 勝敗 -->
                <template x-if="werewolfState.village_won">
                    <div class="bg-gradient-to-r from-blue-300 to-cyan-300 p-6 rounded-2xl">
                        <div class="text-4xl mb-2">🎉🧑‍🌾🎉</div>
                        <h2 class="text-2xl font-bold text-blue-800">村人の勝利！</h2>
                    </div>
                </template>
                <template x-if="!werewolfState.village_won && !werewolfState.is_peace_village">
                    <div class="bg-gradient-to-r from-red-300 to-orange-300 p-6 rounded-2xl">
                        <div class="text-4xl mb-2">🐺🌙🐺</div>
                        <h2 class="text-2xl font-bold text-red-800">人狼の勝利！</h2>
                    </div>
                </template>
                <template x-if="werewolfState.is_peace_village && werewolfState.village_won">
                    <div class="bg-gradient-to-r from-green-300 to-emerald-300 p-6 rounded-2xl">
                        <div class="text-4xl mb-2">🌈✨🌈</div>
                        <h2 class="text-2xl font-bold text-green-800">平和村！</h2>
                    </div>
                </template>
                <template x-if="werewolfState.is_peace_village && !werewolfState.village_won">
                    <div class="bg-gradient-to-r from-amber-300 to-yellow-300 p-6 rounded-2xl">
                        <div class="text-4xl mb-2">😢🌈😢</div>
                        <h2 class="text-2xl font-bold text-amber-800">残念...</h2>
                    </div>
                </template>

                <!-- あなたの役職 -->
                <div class="bg-white/40 p-4 rounded-xl">
                    <div class="text-sm text-violet/70">あなたの最終役職</div>
                    <div class="text-3xl mb-1"
                         x-text="werewolfState.current_roles[clientId] === 'werewolf' ? '🐺' : (werewolfState.current_roles[clientId] === 'seer' ? '🔮' : (werewolfState.current_roles[clientId] === 'thief' ? '🦹' : (werewolfState.current_roles[clientId] === 'madman' ? '🃏' : '🧑‍🌾')))"></div>
                    <div class="text-xl font-bold text-violet"
                         x-text="werewolfState.current_roles[clientId] === 'werewolf' ? '人狼' : (werewolfState.current_roles[clientId] === 'seer' ? '占い師' : (werewolfState.current_roles[clientId] === 'thief' ? '怪盗' : (werewolfState.current_roles[clientId] === 'madman' ? '狂人' : '村人')))"></div>
                </div>

                <p class="text-sm text-violet opacity-70">ホストの画面を見てね！</p>
            </div>
        </template>

        <!-- Ito カード出し確認モーダル -->
        <template x-if="showPlayCardConfirm">
            <div class="fixed inset-0 bg-black/60 z-50 flex justify-center items-center p-4 animate-fade-in">
                <div class="glass-dark p-6 rounded-2xl max-w-sm w-full text-center">
                    <h3 class="text-xl font-bold mb-4 text-white">本当にカードを出しますか？</h3>
                    <p class="text-white/80 mb-6">一度出したカードは戻せません</p>
                    <div class="flex gap-4">
                        <button @click="showPlayCardConfirm = false"
                            class="flex-1 glass px-4 py-3 rounded-full text-white font-bold hover:bg-white/20 transition">
                            キャンセル
                        </button>
                        <button @click="playItoCard"
                            class="flex-1 bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-3 rounded-full font-bold shadow-lg transition">
                            出す！
                        </button>
                    </div>
                </div>
            </div>
        </template>

    </div>

</body>

</html>